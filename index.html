<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Records Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for professional appearance and smooth transitions */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .header-gradient {
            background: linear-gradient(to right, #4f46e5, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-shadow { transition: all 0.2s ease-in-out; }
        .btn-shadow:hover { box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4), 0 4px 6px -2px rgba(79, 70, 229, 0.1); transform: translateY(-2px); }
        .table-container { overflow-y: auto; max-height: 80vh; }
        .table-container table { border-collapse: separate; }
        .table-header th { position: sticky; top: 0; background-color: #e0e7ff; z-index: 10; }
        .admin-email-text { font-family: monospace; }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen p-4 sm:p-8">
        <!-- Application will be rendered here by JavaScript -->
        <div class="flex items-center justify-center h-screen text-indigo-600">
             <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="text-xl font-medium">Starting Application...</p>
        </div>
    </div>

    <script type="module">
        
        // --- SECURE AUTH CONFIGURATION ---
        const ADMIN_EMAIL = 'beloyal.edu@gmail.com';
        // HASH of "AdminSecretKey2025!" using SHA-256
        const SECRET_KEY_HASH = 'b16751280598822005e838e0f10c69d80c3555231908465053e1cc648354c25f'; 

        // --- GOOGLE SHEET CONFIGURATION ---
        const GOOGLE_SHEET_API_URL = 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE'; 
        const USE_MOCK_DATA = GOOGLE_SHEET_API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE';
        
        // --- Core Application State ---
        const CLASS_OPTIONS = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X', 'XI', 'XII'];
        const SECTION_OPTIONS = ['MAHA', 'RISHI', 'NONE'];
        const MOCK_STUDENTS = [
            { id: 'S001', studentId: 'S001', studentName: 'Ravi Sharma', className: 'V', section: 'MAHA', rollNo: '101', dateOfBirth: '2015-05-15', fatherName: 'Ajay Sharma', phoneNumber: '9876543210', emailId: 'ravi@example.com', photoUrl: 'https://placehold.co/100x100/4f46e5/ffffff?text=Ravi', signatureUrl: 'https://placehold.co/150x50/3b82f6/ffffff?text=Sig-A', },
            { id: 'S002', studentId: 'S002', studentName: 'Priya Singh', className: 'IX', section: 'RISHI', rollNo: '205', dateOfBirth: '2011-11-22', fatherName: 'Manoj Singh', phoneNumber: '9988776655', emailId: 'priya@example.com', photoUrl: 'https://placehold.co/100x100/ef4444/ffffff?text=Priya', signatureUrl: 'https://placehold.co/150x50/f9a8d4/ffffff?text=Sig-B', },
        ];
        
        let students = [];
        let isAuthenticated = localStorage.getItem('isAdminAuthenticated') === 'true'; 
        let error = null;
        let isLoading = isAuthenticated; 
        let isFormOpen = false;
        let isSaving = false;
        let currentStudent = null;
        let searchTerm = '';
        let filterClass = 'ALL';
        let filterSection = 'ALL';
        let loginStatus = { message: 'Enter the Admin Secret Key to access the dashboard.', success: false };
        
        // --- Utility Functions ---
        
        const generateId = () => `S${String(students.length + 1).padStart(3, '0')}-${Date.now()}`;
        const getImageUrl = (originalUrl) => {
            if (originalUrl && originalUrl.includes('drive.google.com')) {
                const match = originalUrl.match(/id=([a-zA-Z0-9_-]+)/) || originalUrl.match(/\/d\/([a-zA-Z0-9_-]+)\//);
                const fileId = match ? match[1] : null;
                return fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : originalUrl;
            }
            return originalUrl;
        };
        const getIcon = (name, className = 'w-5 h-5') => {
            if (!window.lucide || !window.lucide.createIcons()[name]) return null;
            const iconElement = window.lucide.createIcons()[name];
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = iconElement.toSvg({ class: className });
            return tempDiv.firstChild;
        };

        const hashSecretKey = async (key) => {
            const encoder = new TextEncoder();
            const data = encoder.encode(key);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        };
        
        // --- Authentication Logic ---
        const handleLogin = async (e) => {
            e.preventDefault();
            const emailInput = document.getElementById('admin-email').value.trim();
            const keyInput = document.getElementById('secret-key').value.trim();
            
            loginStatus.message = 'Verifying key...';
            renderApp();

            if (emailInput !== ADMIN_EMAIL) {
                 loginStatus.message = 'The entered email is incorrect.';
                 document.getElementById('secret-key').value = '';
                 renderApp();
                 return;
            }
            
            try {
                const enteredKeyHash = await hashSecretKey(keyInput);
                
                if (enteredKeyHash === SECRET_KEY_HASH) {
                    isAuthenticated = true;
                    localStorage.setItem('isAdminAuthenticated', 'true');
                    loginStatus.message = 'Login successful!';
                    await loadStudents();
                } else {
                    isAuthenticated = false;
                    loginStatus.message = 'Invalid Secret Key. Access denied.';
                    document.getElementById('secret-key').value = '';
                    renderApp();
                }
            } catch (e) {
                console.error("Login error:", e);
                loginStatus.message = `Authentication failed due to system error.`;
                renderApp();
            }
        };

        const handleLogout = () => {
            isAuthenticated = false;
            localStorage.removeItem('isAdminAuthenticated');
            students = [];
            loginStatus.message = 'Successfully logged out.';
            renderApp();
        };

        // --- Data Persistence and CRUD ---

        const mockFetchStudents = () => {
            return new Promise(resolve => {
                setTimeout(() => { 
                    let data = JSON.parse(localStorage.getItem('mockStudents')) || MOCK_STUDENTS;
                    if (data.length === 0) data = MOCK_STUDENTS;
                    localStorage.setItem('mockStudents', JSON.stringify(data));
                    resolve(data);
                }, 500);
            });
        };
        
        const mockApiAction = (action, studentData) => {
             return new Promise(resolve => {
                setTimeout(() => {
                    let currentStudents = JSON.parse(localStorage.getItem('mockStudents')) || MOCK_STUDENTS;
                    let updatedStudents = [...currentStudents];

                    if (action === 'add') {
                        const newId = generateId();
                        updatedStudents.push({ ...studentData, id: newId });
                    } else if (action === 'update') {
                        updatedStudents = currentStudents.map(s => s.id === studentData.id ? studentData : s);
                    } else if (action === 'delete') {
                        updatedStudents = currentStudents.filter(s => s.id !== studentData.id);
                    }
                    localStorage.setItem('mockStudents', JSON.stringify(updatedStudents));
                    resolve();
                }, 500);
             });
        };
        
        const realFetchStudents = async (retryCount = 0) => {
            const MAX_RETRIES = 3;
            try {
                const response = await fetch(GOOGLE_SHEET_API_URL, { method: 'GET' });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (e) {
                if (retryCount < MAX_RETRIES) {
                    const delay = Math.pow(2, retryCount) * 1000;
                    await new Promise(res => setTimeout(res, delay));
                    return realFetchStudents(retryCount + 1);
                }
                throw new Error("Failed to load student data from Google Sheet API.");
            }
        };

        const realApiAction = async (action, data) => {
             try {
                const response = await fetch(GOOGLE_SHEET_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, data }), 
                });
                if (!response.ok) throw new Error("API action failed.");
            } catch (e) {
                throw new Error(`Failed to perform ${action} operation: ${e.message}`);
            }
        };

        const loadStudents = async () => {
            if (!isAuthenticated) return;
            isLoading = true;
            error = null;
            renderApp(); 

            try {
                let data;
                if (USE_MOCK_DATA) {
                    data = await mockFetchStudents();
                } else {
                    data = await realFetchStudents();
                }

                students = data.map((s, index) => ({ 
                    ...s, 
                    id: s.id || s.studentId || `temp-${index}`,
                    rollNo: String(s.rollNo || ''),
                    phoneNumber: String(s.phoneNumber || ''),
                    className: s.className || 'I',
                    section: s.section || 'NONE',
                }));

            } catch (e) {
                error = e.message;
            } finally {
                isLoading = false;
                renderApp();
            }
        };

        const handleSaveStudent = async (studentData) => {
            isSaving = true;
            error = null;
            renderApp();
            
            const action = studentData.id && students.some(s => s.id === studentData.id) ? 'update' : 'add';

            try {
                if (USE_MOCK_DATA) {
                    await mockApiAction(action, studentData);
                } else {
                    await realApiAction(action, studentData);
                }
                
                await loadStudents();
                isFormOpen = false;
                currentStudent = null;
            } catch (e) {
                error = e.message;
            } finally {
                isSaving = false;
                renderApp();
            }
        };
        
        const handleDeleteStudent = async (studentId) => {
            if (!window.confirm("Are you sure you want to delete this student record?")) {
                return;
            }
            
            try {
                if (USE_MOCK_DATA) {
                    await mockApiAction('delete', { id: studentId });
                } else {
                    await realApiAction('delete', { id: studentId });
                }

                await loadStudents();
            } catch (e) {
                error = e.message;
            } finally {
                renderApp();
            }
        };

        // --- Event Handlers (UI) ---

        const handleFilterChange = (e) => {
            const { id, value } = e.target;
            if (id === 'search') searchTerm = value;
            if (id === 'filterClass') filterClass = value;
            if (id === 'filterSection') filterSection = value;
            renderApp();
        };

        const openAddForm = () => {
            currentStudent = { id: null, studentId: '', studentName: '', className: 'I', section: 'MAHA', rollNo: '', dateOfBirth: '', fatherName: '', phoneNumber: '', emailId: '', photoUrl: '', signatureUrl: '' };
            isFormOpen = true;
            renderApp();
        };

        const openEditForm = (student) => {
            currentStudent = { ...student };
            isFormOpen = true;
            renderApp();
        };

        const closeForm = () => {
            isFormOpen = false;
            currentStudent = null;
            renderApp();
        };

        const handleFormSubmit = (e) => {
            e.preventDefault();
            const form = e.target;
            const data = { id: currentStudent.id };

            const fields = ['studentId', 'studentName', 'className', 'section', 'rollNo', 'dateOfBirth', 'fatherName', 'phoneNumber', 'emailId', 'photoUrl', 'signatureUrl'];
            fields.forEach(field => {
                data[field] = form.elements[field] ? form.elements[field].value : currentStudent[field];
            });
            
            if (!data.studentId || !data.studentName) {
                console.error("Validation Error: Student ID and Name are mandatory.");
                return;
            }

            handleSaveStudent(data);
        };

        // --- Core Render Function ---
        
        const renderApp = () => {
            const appDiv = document.getElementById('app');
            
            // Re-bind global functions for inline HTML event handlers
            window.handleFilterChange = handleFilterChange;
            window.openAddForm = openAddForm;
            window.openEditForm = openEditForm;
            window.closeForm = closeForm;
            window.handleDeleteStudent = handleDeleteStudent;
            window.handleFormSubmit = handleFormSubmit;
            window.handleLogin = handleLogin;
            window.handleLogout = handleLogout;
            
            let mainContent;

            if (isAuthenticated) {
                 // --- RENDER DASHBOARD ---
                mainContent = `
                    ${renderHeader()}
                    ${renderAlert()}
                    ${renderControls()}
                    ${renderTable()}
                    ${isFormOpen ? renderFormModal() : ''}
                `;
            } else {
                 // --- RENDER LOGIN SCREEN ---
                mainContent = renderLoginModal();
            }
            
            appDiv.innerHTML = mainContent;
        };

        // --- Rendering Helpers (MUST be defined before renderApp is called) ---

        const renderImageDisplay = (url, type, className, style) => {
            const finalUrl = getImageUrl(url);
            const iconName = type === 'photo' ? 'User' : 'Zap';

            const container = document.createElement('div');
            container.className = `${className} bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center text-xs text-gray-500 overflow-hidden`;
            
            const img = document.createElement('img');
            img.src = finalUrl;
            img.alt = `${type} of student`;
            img.className = className.replace('flex items-center justify-center text-xs text-gray-500', '') + ' object-cover';
            img.style.cssText = style || '';
            img.loading = 'lazy';
            
            let errorFlag = false;
            
            img.onerror = () => {
                if (!errorFlag) {
                    errorFlag = true;
                    container.innerHTML = '';
                    const icon = getIcon(iconName, 'w-5 h-5');
                    if (icon) container.appendChild(icon);
                    else container.textContent = type === 'photo' ? 'P' : 'S';
                    container.classList.add('p-1');
                }
            };

            if (url && url.length > 5) {
                container.appendChild(img);
            } else {
                const icon = getIcon(iconName, 'w-5 h-5');
                if (icon) container.appendChild(icon);
                else container.textContent = type === 'photo' ? 'P' : 'S';
                container.classList.add('p-1');
            }

            return container.outerHTML;
        };

        const renderTable = () => {
            const filtered = students.filter(s => {
                const searchMatch = searchTerm.toLowerCase();
                const passesSearch = !searchTerm || (s.studentId && s.studentId.toLowerCase().includes(searchMatch)) || (s.studentName && s.studentName.toLowerCase().includes(searchMatch)) || (s.phoneNumber && s.phoneNumber.toLowerCase().includes(searchMatch)) || (s.fatherName && s.fatherName.toLowerCase().includes(searchMatch)) || (s.rollNo && String(s.rollNo).toLowerCase().includes(searchMatch));
                const passesClass = filterClass === 'ALL' || s.className === filterClass;
                const passesSection = filterSection === 'ALL' || s.section === filterSection;
                return passesSearch && passesClass && passesSection;
            }).sort((a, b) => {
                const rollA = parseInt(a.rollNo, 10);
                const rollB = parseInt(b.rollNo, 10);
                if (!isNaN(rollA) && !isNaN(rollB)) { return rollA - rollB; }
                return (a.rollNo || '').localeCompare(b.rollNo || '');
            });
            
            const loadingIcon = getIcon('Loader2', 'w-9 h-9 animate-spin mr-4');
            const editIcon = getIcon('Edit', 'w-4 h-4');
            const trashIcon = getIcon('Trash2', 'w-4 h-4');
            const phoneIcon = getIcon('Phone', 'w-3.5 h-3.5 mr-1 text-indigo-500');
            const calendarIcon = getIcon('Calendar', 'w-3.5 h-3.5 mr-1 text-indigo-500');

            if (isLoading && filtered.length === 0) {
                return `
                    <div class="flex items-center justify-center p-16 text-indigo-600">
                        ${loadingIcon ? loadingIcon.outerHTML : ''}
                        <p class="text-xl font-medium">Loading student data...</p>
                    </div>
                `;
            }

            return `
                <div class="bg-white rounded-2xl shadow-lg overflow-x-auto border border-gray-100 table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-indigo-50/50 backdrop-blur-sm sticky top-0 z-10 shadow-sm table-header">
                            <tr>
                                <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Photo</th>
                                <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">ID / Name</th>
                                <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Class / Sec</th>
                                <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Roll No</th>
                                <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider hidden sm:table-cell">Contact / DoB</th>
                                <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider hidden md:table-cell">Father</th>
                                <th class="px-4 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Signature</th>
                                <th class="px-4 py-4 text-right text-xs font-bold text-gray-700 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                            ${filtered.length === 0 ? `
                                <tr>
                                    <td colSpan="8" class="px-6 py-8 text-center text-lg text-gray-500 bg-gray-50">
                                        No student records found matching the current filters.
                                    </td>
                                </tr>
                            ` : filtered.map(student => {
                                const serializedStudent = JSON.stringify(student).replace(/"/g, '&quot;');
                                return `
                                <tr class="hover:bg-indigo-50/50 transition duration-150">
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        ${renderImageDisplay(student.photoUrl, 'photo', 'w-12 h-12 object-cover rounded-xl shadow-md')}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="text-sm font-bold text-indigo-700">${student.studentId}</div>
                                        <div class="text-xs text-gray-600">${student.studentName}</div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">
                                        <div class="font-semibold text-lg">${student.className}</div>
                                        <div class="text-xs text-gray-500 italic">Section: ${student.section}</div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-lg font-extrabold text-green-700">${student.rollNo}</td>
                                    
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 hidden sm:table-cell">
                                        <div class="flex items-center text-xs text-gray-700">${phoneIcon ? phoneIcon.outerHTML : ''}${student.phoneNumber}</div>
                                        <div class="flex items-center text-xs text-gray-500 mt-1">${calendarIcon ? calendarIcon.outerHTML : ''}${student.dateOfBirth || 'N/A'}</div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 hidden md:table-cell">${student.fatherName}</td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        ${renderImageDisplay(student.signatureUrl, 'signature', 'w-24 h-10 object-contain rounded-md')}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                        <div class="flex justify-end space-x-2">
                                            <button onclick="openEditForm(${serializedStudent})" 
                                                    class="p-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-150"
                                                    title="Edit">
                                                ${editIcon ? editIcon.outerHTML : ''}
                                            </button>
                                            <button onclick="handleDeleteStudent('${student.id}')"
                                                    class="p-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition duration-150"
                                                    title="Delete">
                                                ${trashIcon ? trashIcon.outerHTML : ''}
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        };

        const renderHeader = () => { 
            const logoutIcon = getIcon('LogOut', 'w-4 h-4 ml-2');
            const icon = getIcon('Users', 'w-10 h-10 mr-3 text-indigo-600');
            const userIcon = getIcon('User', 'w-4 h-4 mr-1');

            return `
                <header class="bg-white shadow-xl rounded-3xl p-6 mb-8 border-t-4 border-indigo-600">
                    <div class="flex flex-col sm:flex-row justify-between items-start">
                        <h1 class="text-4xl font-extrabold text-gray-900 flex items-center mb-4 sm:mb-0">
                            ${icon ? icon.outerHTML : ''}
                            <span class="header-gradient">Student Records Dashboard</span>
                        </h1>
                        <div class="flex items-center text-sm text-gray-500">
                            ${userIcon ? userIcon.outerHTML : ''}
                            Admin: <span class="font-mono ml-1 px-3 py-1 bg-indigo-100/50 text-indigo-800 rounded-lg text-xs shadow-inner admin-email-text">${ADMIN_EMAIL}</span>
                            <button onclick="handleLogout()" class="ml-4 px-3 py-1 bg-red-500 text-white text-xs rounded-lg hover:bg-red-600 transition duration-150 flex items-center btn-shadow">
                                Logout ${logoutIcon ? logoutIcon.outerHTML : ''}
                            </button>
                        </div>
                    </div>
                </header>
            `;
        };
        const renderAlert = () => {
            if (!USE_MOCK_DATA && !error) return '';
            
            const isError = error && !USE_MOCK_DATA;
            const className = isError ? 'bg-red-100 border-2 border-red-400 text-red-800' : 'bg-yellow-100 border-2 border-yellow-400 text-yellow-800';
            const message = isError 
                ? `API ERROR: ${error}`
                : `MOCK DATA MODE: Data is stored locally in your browser. Replace the 'GOOGLE_SHEET_API_URL' constant to connect to your real Google Sheet.`;
            const icon = getIcon('AlertTriangle', 'w-5 h-5 mr-2');

            return `
                <div class="px-6 py-4 rounded-xl relative mb-6 font-semibold shadow-md ${className}" role="alert">
                    <p class="flex items-center">
                        ${icon ? icon.outerHTML : ''}
                        ${message}
                    </p>
                </div>
            `;
        };

        const renderControls = () => {
            const searchIcon = getIcon('Search', 'w-5 h-5 text-indigo-400');
            const plusIcon = getIcon('Plus', 'w-5 h-5 mr-2');

            return `
                <div class="bg-white p-6 rounded-2xl shadow-lg mb-8 border border-gray-100">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="md:col-span-2">
                            <label for="search" class="block text-sm font-medium text-gray-700">Quick Search</label>
                            <div class="relative mt-1">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    ${searchIcon ? searchIcon.outerHTML : ''}
                                </div>
                                <input id="search" type="text" value="${searchTerm}" oninput="handleFilterChange(event)"
                                    placeholder="Search ID, Name, Roll No, or Phone No..." 
                                    class="w-full p-2 pl-10 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition duration-150 ease-in-out shadow-inner"
                                />
                            </div>
                        </div>

                        <div>
                            <label for="filterClass" class="block text-sm font-medium text-gray-700">Filter by Class</label>
                            <select id="filterClass" value="${filterClass}" onchange="handleFilterChange(event)"
                                class="mt-1 block w-full py-2.5 px-3 border-2 border-gray-300 bg-white rounded-xl shadow-inner focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                                <option value="ALL">-- All Classes --</option>
                                ${CLASS_OPTIONS.map(c => `<option value="${c}" ${filterClass === c ? 'selected' : ''}>Class ${c}</option>`).join('')}
                            </select>
                        </div>

                        <div>
                            <label for="filterSection" class="block text-sm font-medium text-gray-700">Filter by Section</label>
                            <select id="filterSection" value="${filterSection}" onchange="handleFilterChange(event)"
                                class="mt-1 block w-full py-2.5 px-3 border-2 border-gray-300 bg-white rounded-xl shadow-inner focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                                <option value="ALL">-- All Sections --</option>
                                ${SECTION_OPTIONS.map(s => `<option value="${s}" ${filterSection === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-5">
                        <button onclick="openAddForm()" class="btn-shadow px-4 py-2 rounded-xl text-sm font-semibold transition duration-300 ease-in-out flex items-center justify-center shadow-lg hover:shadow-xl bg-green-600 text-white hover:bg-green-700 focus:ring-4 focus:ring-green-500/50">
                            ${plusIcon ? plusIcon.outerHTML : ''}
                            Add New Student Record
                        </button>
                    </div>
                </div>
            `;
        };

        const renderFormInput = (label, id, value, placeholder, required, icon, disabled = false, type = 'text', className = '') => {
            const iconHtml = icon ? `<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">${icon.outerHTML}</div>` : '';
            const padding = icon ? 'pl-10' : 'pl-3';
            const disabledClass = disabled ? 'bg-gray-100 cursor-not-allowed' : '';
            
            return `
                <div class="flex flex-col space-y-1 ${className}">
                    <label for="${id}" class="text-sm font-medium text-gray-700">${label} ${required ? '<span class="text-red-500">*</span>' : ''}</label>
                    <div class="relative">
                        ${iconHtml}
                        <input id="${id}" type="${type}" value="${value || ''}" placeholder="${placeholder}" ${required ? 'required' : ''} ${disabled ? 'disabled' : ''}
                            class="w-full p-2 ${padding} border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition duration-150 ease-in-out shadow-inner ${disabledClass}"
                        >
                    </div>
                </div>
            `;
        };

        const renderFormSelect = (label, id, value, options, className = '') => {
            return `
                <div class="flex flex-col space-y-1 ${className}">
                    <label for="${id}" class="text-sm font-medium text-gray-700">${label}</label>
                    <select id="${id}"
                        class="mt-1 block w-full py-2.5 px-3 border-2 border-gray-300 bg-white rounded-xl shadow-inner focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        ${options.map(o => `<option value="${o.value}" ${value === o.value ? 'selected' : ''}>${o.label}</option>`).join('')}
                    </select>
                </div>
            `;
        };

        const renderFormModal = () => {
            if (!isFormOpen) return '';
            
            const student = currentStudent;
            const isEditMode = !!student.id && students.some(s => s.id === student.id);
            const title = isEditMode ? 'Edit Student Record' : 'Add New Student';
            
            const studentIcon = getIcon('GraduationCap', 'w-5 h-5 text-indigo-400');
            const userIcon = getIcon('User', 'w-5 h-5 text-indigo-400');
            const zapIcon = getIcon('Zap', 'w-5 h-5 text-indigo-400');
            const calendarIcon = getIcon('Calendar', 'w-5 h-5 text-indigo-400');
            const hardhatIcon = getIcon('HardHat', 'w-5 h-5 text-indigo-400');
            const phoneIcon = getIcon('Phone', 'w-5 h-5 text-indigo-400');
            const mailIcon = getIcon('Mail', 'w-5 h-5 text-indigo-400');
            const editIcon = getIcon('Edit', 'w-5 h-5 mr-1');
            const plusIcon = getIcon('Plus', 'w-5 h-5 mr-1');
            const closeIcon = getIcon('X', 'w-6 h-6');

            const selectOptionsClass = CLASS_OPTIONS.map(c => ({ value: c, label: `Class ${c}` }));
            const selectOptionsSection = SECTION_OPTIONS.map(s => ({ value: s, label: s }));

            const buttonDisabled = isSaving ? 'disabled' : '';
            
            return `
                <div id="modal-backdrop" class="fixed inset-0 bg-gray-900/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[95vh] overflow-y-auto p-6 transition-all duration-300 transform scale-100 opacity-100 border-t-8 border-indigo-600 ring-4 ring-indigo-500/10">
                        <div class="flex justify-between items-start mb-6 border-b pb-3">
                            <h2 class="text-3xl font-extrabold text-indigo-700">${title}</h2>
                            <button type="button" onclick="closeForm()" class="p-2 rounded-full hover:bg-gray-100 text-gray-500 transition duration-150 shadow-md">
                                ${closeIcon ? closeIcon.outerHTML : ''}
                            </button>
                        </div>

                        <form id="student-form" onsubmit="handleFormSubmit(event)" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${renderFormInput('Student ID', 'studentId', student.studentId, 'Unique Student ID', true, studentIcon, isEditMode)}
                            ${renderFormInput('Student Name', 'studentName', student.studentName, 'Full Name', true, userIcon)}

                            ${renderFormInput('Roll No', 'rollNo', student.rollNo, 'Roll Number', false, zapIcon)}
                            ${renderFormInput('Date of Birth', 'dateOfBirth', student.dateOfBirth, '', false, calendarIcon, false, 'date')}

                            ${renderFormSelect('Class', 'className', student.className, selectOptionsClass)}
                            ${renderFormSelect('Section', 'section', student.section, selectOptionsSection)}

                            ${renderFormInput("Father's Name", 'fatherName', student.fatherName, "Father's Name", false, hardhatIcon)}
                            ${renderFormInput('Phone Number', 'phoneNumber', student.phoneNumber, 'e.g., 919876543210', false, phoneIcon, false, 'tel')}
                            
                            ${renderFormInput('Email ID', 'emailId', student.emailId, 'student@example.com', false, mailIcon, false, 'email', 'md:col-span-2')}

                            ${renderFormInput('Photo URL (Google Drive/Public)', 'photoUrl', student.photoUrl, 'Must be a direct/public URL', false, null, false, 'url', 'md:col-span-2')}
                            ${renderFormInput('Signature URL (Google Drive/Public)', 'signatureUrl', student.signatureUrl, 'Must be a direct/public URL', false, null, false, 'url', 'md:col-span-2')}

                            <div class="md:col-span-2 flex justify-end space-x-3 pt-6 border-t mt-4 border-gray-200">
                                <button type="button" onclick="closeForm()" class="btn-shadow bg-gray-200 text-gray-800 hover:bg-gray-300">Cancel</button>
                                <button type="submit" ${buttonDisabled} class="btn-shadow ${isSaving ? 'opacity-60 cursor-not-allowed' : ''} px-4 py-2 rounded-xl text-sm font-semibold transition duration-300 ease-in-out flex items-center justify-center shadow-lg hover:shadow-xl bg-indigo-600 text-white hover:bg-indigo-700">
                                    ${isSaving ? getIcon('Loader2', 'w-5 h-5 animate-spin mr-1').outerHTML : (isEditMode ? getIcon('Edit', 'w-5 h-5 mr-1').outerHTML : getIcon('Plus', 'w-5 h-5 mr-1').outerHTML)}
                                    ${isSaving ? 'Saving...' : (isEditMode ? 'Update Record' : 'Add Record')}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        };


        // --- Execute Initial Render ---
        
        // This ensures all functions are defined before we try to use them in the asynchronous path.
        if (isAuthenticated) {
            loadStudents(); 
            setInterval(loadStudents, 20000); 
        }
        renderApp();

    </script>
</body>
</html>

